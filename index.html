<!DOCTYPE html>
<html>
<head>
    <title>Cielo Compartido VR</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>

    <style>
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-family: sans-serif; z-index: 999; }
    </style>
</head>
<body>

    <div id="loading">Buscando tu cielo... Por favor acepta la ubicación.</div>

    <a-scene vr-mode-ui="enabled: true" loading-screen="enabled: false">
        <a-assets>
            <img id="sky-texture" src="https://cdn.eso.org/images/publicationjpg/eso0932a.jpg">
        </a-assets>

        <a-entity id="rig" position="0 0 0">
            <a-camera look-controls="magicWindowTrackingEnabled: true"></a-camera>
        </a-entity>

        <a-entity id="celestial-sphere" rotation="0 0 0">
            
            <a-sky src="#sky-texture" radius="5000"></a-sky>

            <a-entity id="couple-marker" rotation="-20 100 0">
                <a-entity position="0 0 -4000">
                    <a-text value="Ana & Carlos" 
                            align="center" color="#FFD700" width="800" position="0 200 0"
                            side="double" font="kelsonsans"></a-text>
                    
                    <a-entity position="0 0 0" scale="50 50 50" rotation="0 0 0">
                        <a-sphere color="red" radius="3" position="-2 1 0"></a-sphere>
                        <a-sphere color="red" radius="3" position="2 1 0"></a-sphere>
                        <a-cone color="red" radius-bottom="0" radius-top="4.2" height="7" position="0 -3 0" rotation="0 0 180"></a-cone>
                    </a-entity>
                    
                    <a-text value="Siempre en nuestras estrellas" 
                            align="center" color="white" width="400" position="0 -250 0"
                            side="double"></a-text>
                </a-entity>
            </a-entity>

        </a-entity>
    </a-scene>

    <script>
        // --- LÓGICA DE ALINEACIÓN ASTRONÓMICA ---

        navigator.geolocation.getCurrentPosition(okPos, errorPos);

        function okPos(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            document.getElementById('loading').innerText = "Calculando estrellas...";
            alignSky(lat, lon);
        }

        function errorPos(err) {
            document.getElementById('loading').innerText = "Error de GPS. Se mostrará un cielo genérico.";
            console.error(err);
        }

        function alignSky(latitude, longitude) {
            const now = new Date();
            const skyContainer = document.getElementById('celestial-sphere');
            const loading = document.getElementById('loading');

            // CÁLCULO SIMPLIFICADO DE ROTACIÓN
            // 1. Inclinación por latitud (Eleva el polo norte celeste)
            const latRotation = 90 - latitude;

            // 2. Rotación por hora (Tiempo Sideral Local aproximado)
            // Usamos SunCalc para obtener la posición del sol como referencia temporal
            const times = SunCalc.getTimes(now, latitude, longitude);
            const solarNoon = times.solarNoon;
            const minutesFromNoon = (now.getTime() - solarNoon.getTime()) / 60000;
            // La tierra rota 0.25 grados por minuto
            // Ajuste manual de offset (180) puede ser necesario dependiendo de la textura del mapa estelar
            let lonRotation = (minutesFromNoon * 0.25) + 180; 

            // Aplicar rotación al contenedor del cielo
            // Nota: El orden de rotación en A-Frame es YXZ por defecto.
            // La rotación en X ajusta la latitud, la Y ajusta la hora/longitud.
            skyContainer.setAttribute('rotation', {
                x: -latitude, // Ajuste de latitud (eleva el polo)
                y: -lonRotation, // Ajuste de hora (giro diario)
                z: 0
            });

            loading.style.display = 'none';
            console.log(`Cielo alineado. Lat: ${latitude}, LonRot: ${lonRotation}`);
        }
    </script>
</body>
</html>
