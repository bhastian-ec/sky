<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Planetario M贸vil</title>
  
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://d3js.org/d3.geo.projection.v0.min.js"></script>
  <script src="https://ofrohn.github.io/celestial-demo/lib/celestial.min.js"></script>
  
  <style>
    body { margin: 0; padding: 0; background: #000; overflow: hidden; }
    
    /* El mapa ocupar谩 todo */
    #celestial-map {
      width: 100vw;
      height: 100vh;
      cursor: move;
    }

    /* Bot贸n flotante para activar el sensor */
    #btn-ar {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid white;
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-family: sans-serif;
      z-index: 999;
      display: block;
    }
  </style>
</head>
<body>

  <div id="celestial-map"></div>
  <button id="btn-ar" onclick="activarSensores()"> Activar Movimiento</button>

  <script type="text/javascript">
    
    // 2. Configuraci贸n para que parezca Stellarium
    var config = { 
      width: 0,           // 0 = pantalla completa autom谩tica
      projection: "airy", // Proyecci贸n realista tipo ojo de pez
      center: [-78.46, -0.18], // Coordenadas iniciales (Ecuador)
      background: { fill: "#000000" }, // Fondo negro puro
      adaptable: true,    // Se adapta al tama帽o del cel
      interactive: true,
      
      // ESTRELLAS Y FORMAS
      stars: { show: true, limit: 6 },
      constellations: { 
        show: true,    // L铆neas
        names: true,   // Nombres (Orion, etc)
        desig: true,   // Designaciones
        linestyle: { stroke: "#cccccc", width: 1.5, opacity: 0.6 } 
      },
      mw: { show: true, style: { fill: "#ffffff", opacity: 0.15 } }, // V铆a L谩ctea
      lines: { graticule: { show: false } }, // Ocultar cuadr铆cula fea
      
      // RUTA DE DATOS (Importante para que no salga pantalla negra)
      // Usamos los datos alojados en el demo oficial para asegurar que carguen
      datapath: "https://ofrohn.github.io/celestial-demo/data/"
    };

    // 3. Iniciar el mapa
    Celestial.display(config);

    // 4. L贸gica del Giroscopio (Movimiento AR)
    function activarSensores() {
      // Ocultar bot贸n
      document.getElementById('btn-ar').style.display = 'none';

      // Pedir permiso en iOS 13+
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response == 'granted') {
              window.addEventListener('deviceorientation', handleOrientation);
            } else {
              alert("Permiso denegado");
            }
          })
          .catch(console.error);
      } else {
        // Android y PC
        window.addEventListener('deviceorientation', handleOrientation);
      }
    }

    function handleOrientation(e) {
      // Convertir datos del giroscopio a rotaci贸n del mapa
      // e.alpha = br煤jula (0-360)
      // e.beta = inclinaci贸n
      
      if(e.alpha && e.beta) {
        // Celestial.rotate rota el mapa. 
        // Invertimos alpha para que coincida con el movimiento natural
        var yaw = -e.alpha; 
        var pitch = e.beta - 90; // Ajuste para mirar al horizonte
        
        // Aplicamos la rotaci贸n
        Celestial.rotate([yaw, pitch, 0]);
      }
    }
  </script>
</body>
</html>
