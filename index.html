<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GPS Alta Precisión</title>
    
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: monospace; }
        
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.8); /* Fondo oscuro inicial */
            transition: opacity 1s;
        }
        
        #status-box {
            background: #000; border: 2px solid #00FF00;
            color: #00FF00; padding: 20px; text-align: center;
            border-radius: 10px; max-width: 80%;
            pointer-events: auto;
        }

        h1 { margin: 0 0 10px 0; font-size: 20px; text-transform: uppercase; }
        .data { font-size: 16px; margin: 5px 0; color: #fff; }
        .warning { color: yellow; font-size: 12px; margin-top: 10px; }

        #btn-force {
            display: none; margin-top: 15px; padding: 10px 20px;
            background: #333; color: white; border: 1px solid white;
            cursor: pointer; text-transform: uppercase;
        }

        /* Ocultar overlay cuando cargue */
        .loaded { opacity: 0; pointer-events: none !important; }
    </style>
</head>

<body>
    <div id="overlay">
        <div id="status-box">
            <h1>Buscando Satélites...</h1>
            <div class="data" id="acc-display">Precisión: --- metros</div>
            <div class="data" id="gps-coords">Esperando señal...</div>
            <div class="warning">⚠️ Acércate a una ventana o sal al exterior.<br>El GPS tarda en calentar.</div>
            <button id="btn-force">USAR ESTA PRECISIÓN AUNQUE SEA MALA</button>
        </div>
    </div>

    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; videoTexture: true;' vr-mode-ui="enabled: false">
        <a-entity id="sky-container"></a-entity>
        <a-camera gps-camera rotation-reader look-controls="enabled: true" far="5000"></a-camera>
    </a-scene>

    <script>
        // --- BASE DE DATOS (Estrellas Principales) ---
        const stars = {
            "Betelgeuse": { ra: 5.919, dec: 7.407, mag: 0.5, color: "#FF5733" },
            "Rigel":      { ra: 5.242, dec: -8.202, mag: 0.1, color: "#ADD8E6" },
            "SIRIUS":     { ra: 6.752, dec: -16.716, mag: -1.4, color: "#FFFFFF" },
            "Antares":    { ra: 16.490, dec: -26.432, mag: 1.0, color: "#FF4500" },
            "Spica":      { ra: 13.421, dec: -11.161, mag: 0.9, color: "#ADD8E6" },
            "Arcturus":   { ra: 14.261, dec: 19.182, mag: -0.05, color: "#FFA500" },
            "Vega":       { ra: 18.616, dec: 38.784, mag: 0.0, color: "#ADD8E6" },
            "Canopus":    { ra: 6.399, dec: -52.696, mag: -0.7, color: "#FFFFFF" },
            "Alpha Cent": { ra: 14.660, dec: -60.834, mag: -0.27, color: "#FFFFE0" },
            "Acrux":      { ra: 12.443, dec: -63.099, mag: 0.77, color: "#ADD8E6" },
            "Dubhe":      { ra: 11.062, dec: 61.751, mag: 1.8, color: "#FFA500" }
        };

        const constellations = [
             ["Betelgeuse", "Rigel"], ["Alpha Cent", "Acrux"] // Ejemplos simples
        ];

        const container = document.getElementById('sky-container');
        const overlay = document.getElementById('overlay');
        const accDisplay = document.getElementById('acc-display');
        const coordsDisplay = document.getElementById('gps-coords');
        const btnForce = document.getElementById('btn-force');

        // --- MATEMÁTICAS ---
        function calculateVector(ra, dec, observer, date) {
            const equator = new Astronomy.Equator(ra, dec, 2000.0);
            const horizon = Astronomy.Horizon(date, observer, equator.ra, equator.dec, 'normal');
            
            if (horizon.altitude < -10) return null; // Ocultar si está bajo el suelo

            const r = 40; // Distancia visual
            const theta = horizon.azimuth * (Math.PI / 180);
            const phi = horizon.altitude * (Math.PI / 180);

            return { 
                x: r * Math.cos(phi) * Math.sin(theta), 
                y: r * Math.sin(phi), 
                z: -r * Math.cos(phi) * Math.cos(theta) 
            };
        }

        function renderSky(lat, lon) {
            container.innerHTML = "";
            const date = new Date();
            const observer = new Astronomy.Observer(lat, lon, 0);

            for (const [name, data] of Object.entries(stars)) {
                const pos = calculateVector(data.ra, data.dec, observer, date);
                if (pos) {
                    stars[name].pos = pos;
                    
                    // Esfera
                    const s = document.createElement('a-sphere');
                    s.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
                    s.setAttribute('radius', Math.max(0.1, 0.4 - (data.mag * 0.1)));
                    s.setAttribute('color', data.color);
                    s.setAttribute('shader', 'flat');
                    container.appendChild(s);

                    // Texto
                    if (data.mag < 1.5) {
                        const t = document.createElement('a-text');
                        t.setAttribute('value', name);
                        t.setAttribute('position', `${pos.x} ${pos.y - 0.7} ${pos.z}`);
                        t.setAttribute('align', 'center');
                        t.setAttribute('scale', '2 2 2');
                        t.setAttribute('look-at', '[camera]');
                        container.appendChild(t);
                    }
                }
            }
            // Líneas simples de conexión
            constellations.forEach(pair => {
                const s1 = stars[pair[0]]; const s2 = stars[pair[1]];
                if (s1 && s2 && s1.pos && s2.pos) {
                    const l = document.createElement('a-entity');
                    l.setAttribute('line', `start: ${s1.pos.x} ${s1.pos.y} ${s1.pos.z}; end: ${s2.pos.x} ${s2.pos.y} ${s2.pos.z}; color: white; opacity: 0.3`);
                    container.appendChild(l);
                }
            });
        }

        // --- LÓGICA DE GPS DE ALTA PRECISIÓN ---
        let watchID = null;
        let bestAccuracy = 99999;
        
        function startHighAccuracyGPS() {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta GPS.");
                return;
            }

            // Usamos watchPosition en lugar de getCurrentPosition
            // Esto se queda "escuchando" a los satélites constantemente
            watchID = navigator.geolocation.watchPosition(
                (pos) => {
                    const acc = pos.coords.accuracy;
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;

                    // Actualizar pantalla
                    accDisplay.innerText = `Precisión: ${acc.toFixed(0)} metros`;
                    coordsDisplay.innerText = `Lat: ${lat.toFixed(4)} Lon: ${lon.toFixed(4)}`;
                    
                    // Colorear según calidad
                    if (acc < 20) accDisplay.style.color = "#00FF00"; // Excelente
                    else if (acc < 100) accDisplay.style.color = "yellow"; // Decente
                    else accDisplay.style.color = "red"; // Mala (Antenas celulares)

                    // SI LA PRECISIÓN ES BUENA (< 50m), INICIAMOS AUTOMÁTICAMENTE
                    if (acc < 50) {
                        finishLoading(lat, lon);
                    }
                    
                    // Guardamos la mejor posición por si el usuario fuerza el inicio
                    bestAccuracy = acc;
                    btnForce.onclick = () => finishLoading(lat, lon);
                    btnForce.style.display = 'inline-block';
                },
                (err) => {
                    coordsDisplay.innerText = "Error: " + err.message;
                    accDisplay.innerText = "Reintentando...";
                },
                {
                    enableHighAccuracy: true, // ¡OBLIGAR SATÉLITES!
                    timeout: 20000,           // Esperar hasta 20 seg por lectura
                    maximumAge: 0             // No usar caché vieja
                }
            );
        }

        function finishLoading(lat, lon) {
            if (watchID) navigator.geolocation.clearWatch(watchID); // Dejar de gastar batería
            overlay.classList.add('loaded'); // Quitar pantalla negra
            renderSky(lat, lon);
            // alert("Cielo cargado con precisión GPS.");
        }

        // --- INICIO ---
        // Pedir permisos primero (iOS)
        document.body.addEventListener('click', () => {
             if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response == 'granted') startHighAccuracyGPS();
                    })
                    .catch(console.error);
            } else {
                startHighAccuracyGPS();
            }
        }, { once: true });

    </script>
</body>
</html>
